{% extends 'base.html' %}
{% load staticfiles %}
{% load ticket_tags %}

{% block extrahead %}
    <link rel="stylesheet" type="text/css" href="{% static "contracts/css/isloading_overlay.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "dataTables-1.10.5/css/bootstrap.min.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "dataTables-1.10.5/css/dataTables.bootstrap.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "contracts/css/bpopup_overlay.css" %}">

    <script type="text/javascript" language="javascript" src="{% static "dataTables-1.10.5/js/jquery.dataTables.min.js" %}"></script>
    <script type="text/javascript" language="javascript" src="{% static "dataTables-1.10.5/js/dataTables.bootstrap.js" %}"></script>
    <script type="text/javascript" language="javascript" src="{% static "contracts/js/jquery.bpopup.min.js" %}"></script>
    <script type="text/javascript" language="javascript" src="{% static "contracts/js/jquery.isloading.min.js" %}"></script>
    <script type="application/javascript">var REMOTE_SYNC_URL = "{% url 'remotesync' %}"</script>
    <script type="text/javascript" language="javascript" src="{% static "contracts/js/sync_controller.js" %}"></script>

    <style>
    </style>
    <script type="application/javascript">
        $(document).ready(function () {
            $("#id_name, #id_contracts").change(function () {
                if ($(this).val()) {
                    $('#form-contracts').submit();
                }
            });
            $('#form_results').DataTable({
                data: [
                    {% for key, objects in data.items %}
                        {%  for object in objects %} {
                            id: "<a href='{{ object|resolve_id_url }}' target='_blank'>#{{ object.pk }}</a>",
                            title: "{{ object.subject }}",
                            created_at: "{{ object.created_at }}",
                            updated_at: "{{ object.updated_at }}",
                            hours: {% load_hours object contract %},
                            status: "{% resolve_status object %}"
                            } {% if not forloop.last %},{% endif %}
                        {% endfor %}
                    {% endfor %}
	            ],
	            columns: [
	                {data: 'id'},
	                {data: 'title'},
	                {data: 'created_at'},
	                {data: 'updated_at'},
	                {data: 'hours'},
                    {data: 'status'}
	            ]
	        });
        })
    </script>
{% endblock %}


{% block content %}
    <div class="container-fluid">
        <div class="container-fluid alert alert-info">
            {% if data %}
                <p>Total de horas do contrato: {{ contract.hours }}
                    <span> | Horas restantes: {% calc_hours_remainder contract data %}</span>
                    <span> | Horas gastas: {% calc_hours_spent contract data %}</span>
                    <button style="float: right" id="btn_show_sync">Sincronizar dados</button>
                </p>
                <div id="sync_box"> <a class="sync_box_btn_close">X</a>
                    <div id="sync_box_info" class="alert alert-warning">
                        <p>Dados sincronizados com <span id="sync_box_state"></span></p>
                        <p>Total de tickets carregados: <span id="sync_box_total"></span></p>
                    </div>
                    <div id="sync_box_error" class="alert alert-danger">
                        <p>Messagem do servidor: <span class="text-warning" id="sync_box_error_message"></span></p>
                    </div>
                </div>
            {% endif %}
        </div>

        <div id="form-container" class="container">
            <form action="." method="post" id="form-contracts" class="form-horizontal">{% csrf_token %}
                <div class="form-group ">{{ form.as_table }}</div>
                <div class="form-group">{{ related_form.as_table }}</div>
                <div class="form-group">{{ period_form.as_table }}</div>
                <div class="form-group">
                    <button type="submit" class="btn btn-default">Enviar</button>
                    <input type="hidden" name="form_step" value="{{ form_step }}">
                </div>
            </form>
        </div>
        {% if data %}
        <div id="results-container" class="container-fluid">
            <table id="form_results" class="table table-striped table-bordered">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>TÃ­tulo</th>
                    <th>Data Inicial</th>
                    <th>Data Final</th>
                    <th>Horas gastas</th>
                    <th>Estado</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        {% endif %}
    </div>
{% endblock %}